<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Fight For a New World</title>

    <!-- Bootstrap -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="js/lib/jquery.i18n/jquery.i18n.js"></script>
    <script src="js/lib/jquery.i18n/jquery.i18n.messagestore.js"></script>
    <script src="js/lib/jquery.i18n/jquery.i18n.fallbacks.js"></script>
    <script src="js/lib/jquery.i18n/jquery.i18n.language.js"></script>
    <script src="js/lib/jquery.i18n/jquery.i18n.parser.js"></script>
    <script src="js/lib/jquery.i18n/jquery.i18n.emitter.js"></script>
    <script src="js/lib/jquery.i18n/jquery.i18n.emitter.bidi.js"></script>
    <script src="antixss.js" type="text/javascript"></script>


</head>

<body>
  <header style="box-shadow: 0 4px 2px -2px darkgray; top: 0; bottom: 0; height: 70px; position: absolute; padding: 0; margin: 0; width: 100%;">
    <h1>Fight For A New World</h1>
  </header>

  <canvas id="canvas" width="300" height="300"></canvas>

    <div id="root">

    </div>

    <footer class="footer">
        <div class="container">
            <span><a style="color: black;">&COPY; Cornelius Frylinck</a></span>
        </div>
    </footer>

    <div id="script"></div>

</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>


<script>

  var state = 'login';
	var socket = io();

  function newPage(data) {
    socket.emit('state', data);
  }


  socket.on('state', function(data) {
    state = data;
    socket.emit('state', data);
  })

  socket.on('root', (data) => {
    document.getElementById('root').innerHTML = data;
    socket.emit('root_done', state);
  })

  socket.on('add_buildings', function(data) {
    console.log("add builds html" + data);
    document.getElementById('buildings').innerHTML = data;
  })

  var HttpClient = function() {
      this.get = function(aUrl, aCallback) {
          var anHttpRequest = new XMLHttpRequest();
          anHttpRequest.onreadystatechange = function() {
              if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                  aCallback(anHttpRequest.responseText);
          }

          anHttpRequest.open( "GET", aUrl, true );
          anHttpRequest.send( null );
      }
  }
  var client = new HttpClient();

  /*function setJs(page) {
    client.get(`./${page}/${page}.js`, function(response) {
      document.getElementById('script').innerHTML = response;
      console.log(response);
    });
  }

  function setHtml(page) {
    client.get(`./${page}/${page}.html`, function(response) {
      document.getElementById('root').innerHTML = response;
      //console.log(response);
    });

    if(page == 'home') {
      home_init();
    }
  }

  function setRoot(page) {
    client.open('GET', `./${page}/${page}.html`);
    client.onreadystatechange = function() {
      document.getElementById('root').innerHTML = client.responseText;
        console.log(client.responseText);
    }
    client.send();


    setHtml(page);

    client.get(`./api/${page}`, function(response) {
      document.getElementById('root').innerHTML = response;
      console.log(response);
    });
  }*/


  var canvas = document.querySelector('canvas');

  var c = canvas.getContext('2d');

  var stars = [];

  var colors = [
    '#FFF84E',
    '#FFB159',
    '#FF2B1C',
    '#DCCEFF',
    '#89F9FF'
  ]

  function capRandom(temp) {
    if(temp <= 0) {
      if( temp > -0,1) {
        temp = -0.15;
      }
    }else {
      if( temp < 0,1) {
        temp = 0.15;
      }
    }
    return temp;
  }

  function randomStar() {
    this.radius = Math.max(Math.random() / 2, 0.15);
    this.x = Math.random() * (innerWidth - this.radius * 2) + this.radius;
    this.y = Math.random() * (innerHeight - this.radius * 2) + this.radius;
    let temp = Math.random() - 0.5;
    this.dx = capRandom(temp) * 3;
    temp = Math.random() - 0.5;
    if(temp < -0.3) {
      this.fstyle = colors[0];
    }if(temp < -0.1) {
      this.fstyle = colors[1];
    }if(temp < 0.1) {
      this.fstyle = colors[2];
    }if(temp < 0.3) {
      this.fstyle = colors[3];
    }else {
      this.fstyle = colors[4];
    }
    this.dy = capRandom(temp) * 3;

    this.draw = () => {
      c.beginPath();
      c.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
      c.fillStyle = this.fstyle;
      c.strokeStyle = 'white';
      c.fill();
    }

    this.update = () => {
      if (this.x + this.radius > canvas.width
        || this.x - this.radius < 0) {
          this.dx = -this.dx;
        }
      if (this.y + this.radius > canvas.height - 60
        || this.y - this.radius < 0) {
          this.dy = -this.dy;
        }

        this.x += this.dx;
        this.y += this.dy;

        this.draw();
    }
  }

  for(let i = 0; i < innerWidth; i++) {
    stars.push(new randomStar());
  }

  var frameCount = 0;


/*  var HttpClient = function() {
    this.get = function(aUrl, aCallback) {
        var anHttpRequest = new XMLHttpRequest();
        anHttpRequest.onreadystatechange = function() {
            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                aCallback(anHttpRequest.responseText);
        }

        anHttpRequest.open( "GET", aUrl, true );
        anHttpRequest.send( null );
    }
}

  var client = new HttpClient();
  //client.get('http://some/thing?with=arguments', function(response) {
  client.get('./api/start_buildings', function(response) {
      console.log(response);
  });*/

  /*  $(document).ready(function(){
      $.ajaxSetup({
        headers: {
          'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
        }
      });

      $.get("./api/start_buildings")
        .done(function(data) {
            if(data.length > 0) {
              building_list = data;
              setBuildings();
            }
        });


        $.get("./api/start_res_details")
          .done(function(data) {
            setRes(data);
          });
    });*/

    function animate() {
      frameCount ++;
      if(frameCount % 20 == 0) {
        stars.pop();
        stars.push(new randomStar());
      }
      c.clearRect(0, 0, innerWidth, innerHeight);

      for (let i = 0; i < stars.length; i++) {
        stars[i].update();
      }
    }

    //setRoot('home');

    setInterval(() => {
      requestAnimationFrame(animate);

      /*if(state == 'home') {
        home_update();
      }*/
    }, 200)

</script>


</html>


<script>

    	//Submit data when enter key is pressed
        $('#user_name').keydown(function(e) {
        	var name = $('#user_name').val();
            if (e.which == 13 && name.length > 0) { //catch Enter key
            	//POST request to API to create a new visitor entry in the database
                $.ajax({
				  method: "POST",
				  url: "./api/visitors",
				  contentType: "application/json",
				  data: JSON.stringify({name: name })
				})
                .done(function(data) {
                    if(data && data.name){
                        if(data._id)
                            $('#response').html($.i18n('added_to_database', AntiXSS.sanitizeInput(data.name)));
                        else
                            $('#response').html($.i18n('hello', AntiXSS.sanitizeInput(data.name)));
                    }
                    else {
                        $('#response').html(AntiXSS.sanitizeInput(data));
                    }
                    $('#nameInput').hide();
                    getNames();
                });
            }
        });

        //Retrieve all the visitors from the database
        function getNames(){
          $.get("./api/visitors")
              .done(function(data) {
                  if(data.length > 0) {
                    data.forEach(function(element, index) {
                      data[index] = AntiXSS.sanitizeInput(element)
                    });
                    $('#databaseNames').html($.i18n('database_contents') + JSON.stringify(data));
                  }
              });
          }

          //Call getNames on page load.
          getNames();


    </script>
